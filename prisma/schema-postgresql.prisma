datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client"
    output   = "prisma/src/generated/prisma"
}

// enum
enum StaffRole {
    teacher
    vicePrincipal
    principal
}

enum StudentRole {
    student
}

enum Grade {
    tenth
    eleventh
    twelfth
}

enum Major {
    accounting
    softwareEngineering
}

enum Semester {
    first
    second
}

enum AssessmentType {
    schoolwork
    homework
    quiz
    exam
    project
    group
}

enum problemPointCategory {
    discipline
    academic
    social
    other
}

enum AttendanceType {
    absent
    sick
    permission
}

// student model
model Student {
    id            String           @id @default(cuid())
    name          String
    email         String           @unique
    password      String?
    emailVerified DateTime?
    isVerified    Boolean
    sessions      StudentSession[]
    role          StudentRole      @default(student)

    grade           Grade
    major           Major
    classNumber     String
    teacherId       String
    homeroomTeacher Teacher @relation(fields: [teacherId], references: [id])

    studentSubjects Subject[]           @relation("SubjectStudents")
    subjectMarks    SubjectMark[]
    attendances     StudentAttendance[]
    problemPoints   ProblemPoint[]

    otp             String?
    otpExpiresAt    DateTime?
    otpRequestCount Int       @default(0)
    otpResetAt      DateTime?
    otpAttemptCount Int       @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model SubjectMark {
    id           Int      @id @default(autoincrement())
    subjectName  String
    studentId    String
    student      Student  @relation(fields: [studentId], references: [id])
    academicYear String
    semester     Semester
    marks        Mark[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Mark {
    id            Int         @id @default(autoincrement())
    subjectMarkId Int
    subjectMark   SubjectMark @relation(fields: [subjectMarkId], references: [id])

    type          AssessmentType
    number        Int
    descriptionId Int
    description   MarkDescription @relation(fields: [descriptionId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model MarkDescription {
    id          Int      @id @default(autoincrement())
    givenAt     DateTime @default(now())
    dueAt       DateTime
    submittedAt DateTime

    marks Mark[]
}

model StudentAttendance {
    id        Int     @id @default(autoincrement())
    studentId String
    student   Student @relation(fields: [studentId], references: [id])

    date        DateTime
    type        AttendanceType
    description String?
}

model ProblemPoint {
    id        Int     @id @default(autoincrement())
    studentId String
    student   Student @relation(fields: [studentId], references: [id])

    point       Int
    category    problemPointCategory
    description String
    recordedBy  String
    teacher     Teacher              @relation(fields: [recordedBy], references: [id])
    date        DateTime
}

// teacher model

model Teacher {
    id       String @id @default(cuid())
    name     String 
    email    String @unique
    password String

    role StaffRole

    homeroomClass HomeroomClass?

    teachingAssignments TeachingAssignment[]

    teachingClasses TeachingClass[]

    sessions        TeacherSession[]
    students        Student[]
    problemPoints   ProblemPoint[]
    otp             String?
    otpExpiresAt    DateTime?
    otpRequestCount Int              @default(0)
    otpResetAt      DateTime?
    otpAttemptCount Int              @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model TeachingClass {
    id          Int    @id @default(autoincrement())
    grade       Grade
    major       Major
    classNumber String @default("none")

    teachers Teacher[]

    @@unique([grade, major, classNumber])
}

model HomeroomClass {
    id          Int     @id @default(autoincrement())
    grade       Grade
    major       Major
    classNumber String  @default("none")
    teacherId   String  @unique
    teacher     Teacher @relation(fields: [teacherId], references: [id])

    @@unique([grade, major, classNumber])
}

model TeachingAssignment {
    id Int @id @default(autoincrement())

    teacher   Teacher @relation(fields: [teacherId], references: [id])
    teacherId String

    subject   Subject @relation(fields: [subjectId], references: [id])
    subjectId Int

    grade       Grade
    major       Major
    classNumber String @default("none")

    @@unique([teacherId, subjectId, grade, major, classNumber])
}

// General

model StudentSession {
    sessionToken String  @unique
    studentId    String
    student      Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

    expires   DateTime
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model TeacherSession {
    sessionToken String  @unique
    teacherId    String
    teacher      Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

    expires   DateTime
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Subject {
    id          Int    @id @default(autoincrement())
    subjectName String @unique

    students Student[] @relation("SubjectStudents")

    teachingAssignments TeachingAssignment[]
}

model VerificationToken {
    identifier String
    token      String
    expires    DateTime

    @@id([identifier, token])
}
