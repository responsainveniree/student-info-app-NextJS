datasource db {
    provider = "postgresql"
    url      = env("DATABASE_URL")
}

generator client {
    provider = "prisma-client"
    output   = "prisma/src/generated/prisma"
}

// enum
enum StaffRole {
    TEACHER
    VICE_PRINCIPAL
    PRINCIPAL
}

enum StudentRole {
    STUDENT
    CLASS_SECRETARY
}

enum Outsider {
    PARENT
}

enum Grade {
    TENTH
    ELEVENTH
    TWELFTH
}

enum Major {
    ACCOUNTING
    SOFTWARE_ENGINEERING
}

enum Semester {
    FIRST
    SECOND
}

enum AssessmentType {
    SCHOOLWORK
    HOMEWORK
    QUIZ
    EXAM
    PROJECT
    GROUP
}

enum ProblemPointCategory {
    LATE
    INCOMPLETE_ATTRIBUTES
    DISCIPLINE
    ACADEMIC
    SOCIAL
    OTHER
}

enum AttendanceType {
    LATE
    ALPHA
    SICK
    PERMISSION
}

// student model
model Student {
    id            String           @id @default(cuid())
    name          String
    email         String           @unique
    password      String?
    emailVerified DateTime?
    isVerified    Boolean
    sessions      StudentSession[]
    role          StudentRole      @default(STUDENT)

    grade           Grade
    major           Major
    classNumber     String
    homeroomClassId Int
    homeroomClass   HomeroomClass? @relation(fields: [homeroomClassId], references: [id])

    studentSubjects Subject[]           @relation("SubjectStudents")
    subjectMarks    SubjectMark[]
    attendances     StudentAttendance[]
    problemPoints   ProblemPoint[]

    otp             String?
    otpExpiresAt    DateTime?
    otpRequestCount Int       @default(0)
    otpResetAt      DateTime?
    otpAttemptCount Int       @default(0)

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
    parent    Parent?
    teacher   Teacher? @relation(fields: [teacherId], references: [id])
    teacherId String?

    @@index([email])
}

model SubjectMark {
    id           Int      @id @default(autoincrement())
    subjectName  String
    subject      Subject  @relation(fields: [subjectName], references: [subjectName])
    studentId    String
    student      Student  @relation(fields: [studentId], references: [id])
    academicYear String
    semester     Semester
    marks        Mark[]

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([studentId, subjectName, academicYear, semester])
    @@index([studentId])
}

model Mark {
    id            Int         @id @default(autoincrement())
    subjectMarkId Int
    subjectMark   SubjectMark @relation(fields: [subjectMarkId], references: [id])

    type             AssessmentType
    score            Int?
    assessmentNumber Int
    descriptionId    Int
    description      MarkDescription @relation(fields: [descriptionId], references: [id])

    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt

    @@unique([subjectMarkId, assessmentNumber])
    @@index([subjectMarkId])
}

model MarkDescription {
    id      Int      @id @default(autoincrement())
    givenAt DateTime @default(now())
    dueAt   DateTime
    detail  String

    marks Mark[]
}

model StudentAttendance {
    id        Int     @id @default(autoincrement())
    studentId String
    student   Student @relation(fields: [studentId], references: [id])

    date        DateTime       @default(now())
    type        AttendanceType
    description String?

    @@unique([studentId, date])
    @@index([studentId])
}

model ProblemPoint {
    id        Int     @id @default(autoincrement())
    studentId String
    student   Student @relation(fields: [studentId], references: [id])

    point       Int
    category    ProblemPointCategory
    description String
    recordedBy  String
    teacher     Teacher              @relation(fields: [recordedBy], references: [id])
    date        DateTime             @db.Date

    @@index([studentId])
}

// teacher model

model Teacher {
    id       String @id @default(cuid())
    name     String
    email    String @unique
    password String

    role StaffRole @default(TEACHER)

    homeroomClass HomeroomClass?

    teachingAssignments TeachingAssignment[]

    teachingClasses TeachingClass[]

    sessions        TeacherSession[]
    problemPoints   ProblemPoint[]
    otp             String?
    otpExpiresAt    DateTime?
    otpRequestCount Int              @default(0)
    otpResetAt      DateTime?
    otpAttemptCount Int              @default(0)

    createdAt DateTime  @default(now())
    updatedAt DateTime  @updatedAt
    students  Student[]

    @@index([email])
}

model TeachingClass {
    id          Int    @id @default(autoincrement())
    grade       Grade
    major       Major
    classNumber String @default("none")

    teachers Teacher[]

    @@unique([grade, major, classNumber])
}

model HomeroomClass {
    id          Int       @id @default(autoincrement())
    grade       Grade
    major       Major
    classNumber String    @default("none")
    teacherId   String    @unique
    teacher     Teacher   @relation(fields: [teacherId], references: [id])
    students    Student[]

    @@unique([grade, major, classNumber])
}

model TeachingAssignment {
    id Int @id @default(autoincrement())

    teacher   Teacher @relation(fields: [teacherId], references: [id])
    teacherId String

    subject   Subject @relation(fields: [subjectId], references: [id])
    subjectId Int

    grade                    Grade
    major                    Major
    classNumber              String @default("none")
    totalAssignmentsAssigned Int    @default(0)

    @@unique([teacherId, subjectId, grade, major, classNumber])
    @@index([teacherId])
}

// Parent model
model Parent {
    id        String   @id @default(cuid())
    email     String   @unique
    password  String
    name      String
    role      Outsider @default(PARENT)
    studentId String   @unique
    student   Student  @relation(fields: [studentId], references: [id])
}

// General

model StudentSession {
    sessionToken String  @unique
    studentId    String
    student      Student @relation(fields: [studentId], references: [id], onDelete: Cascade)

    expires   DateTime
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model TeacherSession {
    sessionToken String  @unique
    teacherId    String
    teacher      Teacher @relation(fields: [teacherId], references: [id], onDelete: Cascade)

    expires   DateTime
    createdAt DateTime @default(now())
    updatedAt DateTime @updatedAt
}

model Subject {
    id          Int    @id @default(autoincrement())
    subjectName String @unique

    students Student[] @relation("SubjectStudents")

    teachingAssignments TeachingAssignment[]
    subjectMarks        SubjectMark[]
}

model VerificationToken {
    identifier String
    token      String
    expires    DateTime

    @@id([identifier, token])
}
